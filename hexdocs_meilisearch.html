<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js"></script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic"
    />
    <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.js"></script>

    <title>Hexdocs+Meilisearch</title>

    <style>
      em {
        display: inline;
        background-color: #f5d0fe;
      }
    </style>
  </head>

  <body>
    <div class="container mx-auto p-4">
      <div class="flex">
        <div id="autocomplete" class="w-full"></div>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const packages = urlParams
        .get("packages")
        ?.split(",")
        .filter((pkg) => pkg.trim() !== "");

      const collection = urlParams.get("collection") || "hexdocs-full-text";

      const client = new MeiliSearch({
        host: "https://meilisearch.copycat.fun",
        apiKey: "hexdocs",
      });

      const index = client.index(collection);

      const { autocomplete } = window["@algolia/autocomplete-js"];

      let placeholder;

      if (packages && packages.length > 0) {
        placeholder = `Search for docs within ${packages.join(", ")}`;
      } else {
        placeholder = "Search for docs across all packages";
      }

      autocomplete({
        container: "#autocomplete",
        placeholder,

        async getSources({ query }) {
          const searchParams = {
            attributesToHighlight: ["title", "doc"],
          };

          if (packages && packages.length > 0) {
            searchParams.filter = [
              packages.map((package) => `package=${package}`),
            ];
          }

          const results = await index.search(query, searchParams);

          return [
            {
              sourceId: collection,
              getItems() {
                return results.hits;
              },
              templates: {
                item({ item, html }) {
                  const title = html`${item._formatted.title || item.title}`;
                  const doc = html`${item._formatted.doc || item.doc}`;

                  return html`<a
                    href="https://hexdocs.pm/${item.package}/${item.ref}"
                    ><div class="p-2 text-sm">
                      <div class="flex items-center space-x-2 text-slate-500">
                        <span>(${item.package})</span>
                        <pre
                          class="text-slate-700"
                          dangerouslySetInnerHTML=${{ __html: title }}
                        ></pre>
                      </div>
                      <pre
                        class="mt-2 p-2 bg-slate-100 border rounded text-slate-700"
                        dangerouslySetInnerHTML=${{ __html: doc }}
                      ></pre></div
                  ></a>`;
                },
                noResults() {
                  return "No results found.";
                },
              },
            },
          ];
        },
      });
    </script>
  </body>
</html>
