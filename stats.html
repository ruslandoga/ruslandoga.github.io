<!DOCTYPE html>
<html>
  <head>
    <title>here, duck</title>
    <meta charset="utf-8" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦†</text></svg>"
    />
    <style type="text/css">
      html,
      body {
        height: 100%;
        width: 100%;
      }
      body {
        background-color: black;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        font-family: monospace;
      }
      ::selection {
        background: #4b2858;
      }
    </style>
    <script type="module">
      import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.1-dev132.0/+esm";

      async function main() {
        const outputDiv = document.getElementById("output");
        let db;

        try {
          outputDiv.textContent = "Initializing DuckDB...";
          const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
          const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

          const scriptURL = URL.createObjectURL(
            new Blob([`importScripts("${bundle.mainWorker}");`], {
              type: "text/javascript",
            })
          );

          const worker = new Worker(scriptURL);
          const logger = new duckdb.ConsoleLogger();
          const db = new duckdb.AsyncDuckDB(logger, worker);

          outputDiv.textContent = "Instantiating DuckDB worker...";
          await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
          URL.revokeObjectURL(scriptURL);

          outputDiv.textContent = "Connecting to database...";
          const c = await db.connect();

          outputDiv.textContent = "Running query...";
          const result = await c.query(
            "select count(*) as heartbeats from 'https://stats.r2.edify.space/test.parquet';"
          );

          const replacer = (key, value) =>
            typeof value === "bigint" ? value.toString() : value;

          outputDiv.textContent = `Query Result: ${JSON.stringify(
            result.toArray(),
            replacer
          )}`;

          await c.close();
          await db.terminate();
        } catch (e) {
          console.error(e);
          outputDiv.textContent = `Error: ${e.message}\n\nSee browser console for more details.`;

          if (typeof db !== "undefined" && db.terminate) {
            try {
              await db.terminate();
            } catch (cleanupError) {
              console.error("Error during cleanup:", cleanupError);
            }
          }
        }
      }

      main();
    </script>
  </head>
  <body>
    <div id="output" style="color: red">
      Loading DuckDB and running query...
    </div>
  </body>
</html>
